<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./icons/new bill.png" type="image/x-icon">
    <title>Billing page</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Firebase App (for Firebase features) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js"></script> -->
    <!-- Firebase Firestore and Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="./bill.css">
</head>

<body>
    <nav class="navbar">
        <div class="iconDiv"><img src="./icons/home.png" title="home" onclick="home()"></div>
        <div class="iconDiv"><img src="./icons/new bill.png" title="new bill" onclick="newBill()"></div>
        <div class="iconDiv"><img src="./icons/ledger.png" title="ledger" onclick="ledger()"></div>
        <div class="iconDiv"><img src="./icons/customer nav.png" title="customers" onclick="customers()"></div>
        <div class="iconDiv"><img src="./icons/inventory-management.png" title="store" onclick="inventory()"></div>
        <div class="iconDiv"><img src="./icons/debt.png" title="debit" onclick=""></div>
        <div class="iconDiv"><img src="./icons/overview nav.png" title="overviw" onclick=""></div>
        <div class="iconDiv"><img src="./icons/info.png" title="info" onclick=""></div>
        <div class="iconDiv"><img src="./icons/logout.png" title="logout" onclick=""></div>


    </nav>
    <div class="homeContainer">
        <div id="customAlert" style="
    display: none; 
    position: fixed; 
    top: 20px; 
    left: 50%; 
    transform: translateX(-50%);
    background-color: #3978de; 
    color: white; 
    padding: 10px 20px; 
    border-radius: 5px; 
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
    font-size: 14px; 
    z-index: 1000;">
        </div>
        <!-- Fixed billRow -->

        <div class="homeBody">
            <!-- Form to add a new product -->
            <span id="heading">Bill</span>
            <div class="billBox">

                <div class="form-container " id="billForm">
                    <div class="inputboxes">
                        <!-- <div class="inputDiv"> -->
                        <div>
                            <label for="customerNameName" class="form-label">Customer Name:</label>
                            <!-- Input field with datalist for suggestions -->
                            <input type="text" class="form-control input" id="customerNameName"
                                placeholder="Enter Customer Name" list="customerSuggestions" autocomplete="off"
                                required>
                            <!-- Datalist for customer name suggestions -->
                            <datalist id="customerSuggestions"></datalist>
                        </div>


                        <div>
                            <label for="phoneNumber" class="form-label">Phone Number:</label>
                            <!-- Phone number field, editable if no matching customer is selected -->
                            <input type="tel" class="form-control input" id="phoneNumber"
                                placeholder="Enter Phone Number" maxlength="10" required>
                        </div>
                        <!-- </div> -->
                        <div>
                            <label for="salesMan" class="form-label">Sales Man:</label>
                            <!-- Phone number field, editable if no matching customer is selected -->
                            <input type="name" class="form-control input" id="salesMan" placeholder="Enter Name">
                        </div>




                        <!-- <div class="inputDiv"> -->
                        <div>
                            <label for="dateField" class="form-label">Select Date:</label>
                            <input type="text" id="dateField" class="form-control input" readonly
                                placeholder="dd-mm-yyyy" required>

                        </div>

                        <div>
                            <label for="transactionType" class="form-label">Transaction Type:</label>
                            <select id="transactionType" class="form-control  inputTrans" required>
                                <option value="Full Payment">Full Payment</option>
                                <option value="credit">Credit</option>


                            </select>
                        </div>
                        <!-- </div> -->
                        <!-- <div class="inputDiv"> -->


                        <div>
                            <label for="transactionMode" class="form-label">Transaction Mode:</label>
                            <select id="transactionMode" class="form-control  inputTrans" required>
                                <option value="cash">Cash</option>
                                <option value="UPI">UPI</option>
                            </select>
                        </div>
                    </div>
                    <!-- </div> -->





                    <div class="mt-3 d-flex align-items-center ">
                        <label for="addItemButton" class="form-label  ">Add items :</label>
                        <button id="addItemButton" class="btn btn-primary ms-3 mb-3 text-center" onclick="additem()">Add
                            Item</button>
                    </div>

                    <div class="tableContainer">
                        <table class="table table-bordered" id="itemTable">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">S/N</th>
                                    <th style="width: 10%;">Item Code</th>
                                    <th style="width: 20%;">Item Name</th>
                                    <th style="width: 10%;">Qty</th>
                                    <th style="width: 10%;">Unit</th>
                                    <th style="width: 10%;">Rate</th>
                                    <th style="width: 15%;">Amount</th>
                                    <th style="width: 10%;">MRP</th>
                                    <th style="width: 10%;"></th>
                                </tr>
                            <tbody>
                                <!-- Rows will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="bottomRow">
                        <div class="rowGrid">
                            <span>Current Balance : <span id="currentBalance"></span></span>
                            <span style="color: red;">Running Balance : <span id="balanceAmount"></span></span>
                        </div>
                        <div class="rowGrid">
                            <span>Net Amount :<span id="credtotal"></span></span>
                            <span>Paying Amount : <input type="number" name="" id="initialPayment"
                                    class=" input"></span>
                        </div>
                        <div class="buttonGroup">
                            <div class="buttons" id="print" style="background-color: rgb(211, 173, 0);">Print</div>
                            <div class="buttons" id="savefb" style="background-color: rgb(5, 165, 173);">Save</div>
                            <div class="buttons" id="creditsave">Save & Print</div>
                        </div>
                    </div>
                </div>



                <div class="save  " id="save" style="display: none;">

                    <div class="TOTAL">
                        Total : <span id="total"></span>
                    </div>
                    <div class="print ms-3 me-2" id="save">save</div>
                </div>




                <!-- table -->


            </div>


            <div class="valuesContainer" id="values" style="display: none;">
                <div class="values">
                    <div id="creditFields" class="gap-0  ">
                        <div>
                            <label for="initialPayment" class="form-label">Paying Amount:</label>
                            <input type="number" id="" class="form-control" placeholder="Enter paying Amount">

                        </div>

                    </div>
                </div>
                <div class="values">
                    <div class="credTotal">Total : </div>
                </div>
                <div class="values">
                    <div class="TOTAL">
                        Balance :
                    </div>
                </div>
                <div class="values">
                    <div class="print ">Save & Print</div>
                </div>

            </div>


        </div>

        <!-- firebase -->
        <script type="module">
            // Firebase imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
            import {
                getFirestore,
                collection,
                addDoc,
                query,
                where,
                getDocs,
                updateDoc,
                doc,
                increment,
                getDoc
            } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyB5Dll51Ier9CDbYfS5D_VBuZCVZdz2wS0",
                authDomain: "full-bill.firebaseapp.com",
                projectId: "full-bill",
                storageBucket: "full-bill.firebasestorage.app",
                messagingSenderId: "866610694066",
                appId: "1:866610694066:web:af68a003b7fa00fe7c86ab"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);


            let customers = [];

            async function fetchCustomers() {
                try {
                    const billsRef = collection(db, "bills");
                    const querySnapshot = await getDocs(billsRef);
                    customers = querySnapshot.docs.map((doc) => ({
                        customerName: doc.data().customerName,
                        phoneNumber: doc.data().phoneNumber,
                        balanceAmount: doc.data().balanceAmount,

                    }));

                    console.log("Fetched customers:", customers);
                } catch (error) {
                    console.error("Error fetching customers:", error);
                }
            }


            document.getElementById("customerNameName").addEventListener("input", function () {
                const input = this.value.trim().toLowerCase();

                // Find a matching customer
                const customer = customers.find(c => c.customerName.toLowerCase() === input);

                if (customer) {
                    // Auto-fill the phone number if a match is found
                    document.getElementById("phoneNumber").value = customer.phoneNumber;
                    document.getElementById("currentBalance").textContent = customer.balanceAmount;
                    window.crrbalanceAmount = customer.balanceAmount;
                    document.getElementById("phoneNumber").setAttribute("readonly", true);

                } else {
                    // Clear phone number field if no match
                    document.getElementById("phoneNumber").value = "";
                    document.getElementById("currentBalance").textContent = "";
                    document.getElementById("phoneNumber").removeAttribute("readonly");
                }

                // Populate the suggestions list
                const suggestions = customers
                    .filter(c => c.customerName.toLowerCase().includes(input))
                    .map(c => c.customerName);

                const datalist = document.getElementById("customerSuggestions");
                datalist.innerHTML = suggestions.map(name => `<option value="${name}">`).join('');
            });



            fetchCustomers();


            window.fetchSuggestions = async (input, field) => {
                if (!input || !field) return [];

                try {
                    const inventoryRef = collection(db, "inventory");
                    const q = query(inventoryRef, where(field, ">=", input), where(field, "<=", input + "\uf8ff")); // Prefix match query
                    const querySnapshot = await getDocs(q);

                    const suggestions = [];
                    querySnapshot.forEach((doc) => {
                        suggestions.push({ id: doc.id, ...doc.data() });
                    });

                    return suggestions;
                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                    return [];
                }
            };




            window.updateStock = async (itemCode, quantity) => {
                try {
                    const itemDocRef = doc(db, "inventory", itemCode);
                    const itemDocSnap = await getDoc(itemDocRef);

                    if (itemDocSnap.exists()) {
                        const currentStock = itemDocSnap.data().stock || 0;

                        if (currentStock < quantity) {
                            showAlert("Insufficient stock available!", 2500);
                            return false;
                        }

                        const newStock = currentStock - quantity;

                        await updateDoc(itemDocRef, { stock: newStock });
                        console.log(`Stock updated for ${itemCode}: ${newStock}`);
                        return true;
                    } else {
                        showAlert(`Item with code ${itemCode} not found in the database.`, 2500);
                        return false;
                    }
                } catch (error) {
                    console.error("Error updating stock:", error);
                    return false;
                }
            };

            const saveData = async () => {

                if (!validateTable()) {
                    return; // Stop further execution if validation fails
                }
                const rows = document.querySelectorAll("#itemTable tbody tr");

                for (const row of rows) {
                    const itemCode = row.querySelector(".item-code-input").value.trim();
                    const quantity = parseInt(row.querySelector(".qty-input").value.trim(), 10);

                    if (itemCode && quantity > 0) {
                        const stockUpdated = await window.updateStock(itemCode, quantity);
                        if (!stockUpdated) {
                            return false; // Stop if any stock update fails
                        }
                    }
                }


                return true;
            };

            const validateTable = () => {
                const table = document.getElementById("itemTable").querySelector("tbody");
                if (!table || table.rows.length === 0) {
                    showAlert("Add at least one item.", 2500);
                    return false;
                }

                for (const [index, row] of Array.from(table.rows).entries()) {
                    const itemCodeInput = row.querySelector(".item-code-input");
                    const itemNameInput = row.querySelector(".item-name-input");
                    const qtyInput = row.querySelector(".qty-input");
                    const rateInput = row.querySelector(".rate-input");

                    const itemCode = itemCodeInput ? itemCodeInput.value.trim() : null;
                    const itemName = itemNameInput ? itemNameInput.value.trim() : null;
                    const qty = qtyInput ? qtyInput.value.trim() : null;
                    const rate = rateInput ? rateInput.value.trim() : null;

                    if (!itemCode) {
                        showAlert(`Item code is missing in row ${index + 1}.`, 2500);
                        return false;
                    }

                    if (!itemName) {
                        showAlert(`Item name is missing in row ${index + 1}.`, 2500);
                        return false;
                    }

                    if (!qty || isNaN(qty) || parseInt(qty, 10) <= 0) {
                        showAlert(`Invalid quantity in row ${index + 1}.`, 2500);
                        return false;
                    }

                    if (!rate || isNaN(rate) || parseFloat(rate) <= 0) {
                        showAlert(`Invalid rate in row ${index + 1}.`, 2500);
                        return false;
                    }
                }

                return true; // If all validations pass
            };


            async function validateAndSaveTransaction(action) {
                try {
                    const customerName = document.getElementById("customerNameName").value.trim();
                    const phoneNumber = document.getElementById("phoneNumber").value.trim();
                    const date = document.getElementById("dateField").value.trim();
                    const transactionType = document.getElementById("transactionType").value.trim();
                    const transactionMode = document.getElementById("transactionMode").value.trim();
                    const initialPayment = parseFloat(document.getElementById("initialPayment").value || "0");
                    const totalAmount = parseFloat(document.getElementById("credtotal").textContent || "0");
                    const balanceAmount = parseFloat(document.getElementById("balanceAmount").textContent || "0");

                    // Validations
                    if (!customerName || !phoneNumber || !date || !transactionType || !transactionMode) {
                        showAlert("All fields are required.", 2500);
                        return;
                    }

                    if (!/^\d{10}$/.test(phoneNumber)) {
                        showAlert("Phone number must be exactly 10 digits.", 2500);
                        return;
                    }

                    if (initialPayment === totalAmount && transactionType === "credit") {
                        showAlert("Transaction type cannot be 'Credit' when the full amount is paid.", 2500);
                        return;
                    }
                    validateTable();




                    // Save or update transaction
                    const result = await saveOrUpdateTransaction(
                        customerName,
                        phoneNumber,
                        date,
                        transactionType,
                        transactionMode,
                        initialPayment,
                        totalAmount,
                        balanceAmount
                    );

                    if (result) {
                        const stockUpdated = await saveData();

                        if (stockUpdated) {
                            if (action === "savePrint") {
                                window.pdfload(); // Generate and print the PDF
                                showAlert("Transaction saved and printed successfully!", 3000);
                                window.location.reload();
                            } else if (action === "save") {
                                showAlert("Transaction saved successfully!", 3000);
                                window.location.reload();
                            }
                        } else {
                            showAlert("Error updating stock. Transaction not fully saved.", 3000);
                        }
                    }
                } catch (error) {
                    console.error("Error during validation and save:", error);
                    showAlert("An error occurred. Please try again.", 3000);
                }
            }

            async function saveOrUpdateTransaction(customerName, phoneNumber, date, transactionType, transactionMode, initialPayment, totalAmount, balanceAmount) {
                try {
                    const billsRef = collection(db, "bills");
                    const customerQuery = query(billsRef, where("customerName", "==", customerName));
                    const querySnapshot = await getDocs(customerQuery);

                    // Generate a unique invoice number
                    const generateUniqueInvoiceNo = async () => {
                        const allDocs = await getDocs(billsRef);
                        const allInvoices = allDocs.docs.flatMap((doc) => doc.data().invoiceNumbers || []);
                        return `INV-${String(allInvoices.length + 1).padStart(3, "0")}`;
                    };

                    const newInvoiceNo = await generateUniqueInvoiceNo();
                    window.InvoiceNo = newInvoiceNo;


                    // Collect items from the table
                    const newItems = Array.from(document.querySelectorAll("#itemTable tbody tr")).map((row) => {
                        const cells = row.querySelectorAll("td");
                        return {

                            itemCode: cells[1].querySelector("input").value,
                            itemName: cells[2].querySelector("input").value,
                            itemQty: parseFloat(cells[3].querySelector("input").value || "0"),
                            itemUnit: cells[4].querySelector("input").value || "",
                            itemRate: parseInt(cells[5].querySelector("input").value || "0"),
                            itemAmount: parseFloat(cells[6].textContent || "0"),
                            itemMRP: parseFloat(cells[7].textContent || "0"),
                        };
                    });

                    if (!querySnapshot.empty) {
                        const docRef = querySnapshot.docs[0].ref;
                        const existingData = querySnapshot.docs[0].data();

                        const updatedInvoiceNumbers = [
                            ...(existingData.invoiceNumbers || []),
                            {
                                invoiceNo: newInvoiceNo,
                                transactionType,
                                date,
                                items: newItems,
                                paidAmount: initialPayment,
                                transactionMode,
                                totalAmount,
                                balanceAmount,

                            },

                        ];

                        const updatedTransactionHistory = [
                            ...(existingData.transactionHistory || []),
                            {
                                paidAmount: initialPayment,
                                timestamp: new Date().toLocaleString(),
                                transactionMode,
                                invoiceNo: newInvoiceNo,
                            },
                        ];

                        const updatedData = {
                            ...existingData,
                            invoiceNumbers: updatedInvoiceNumbers,
                            totalAmount: (existingData.totalAmount || 0) + totalAmount,
                            balanceAmount: (existingData.balanceAmount || 0) + balanceAmount,
                            transactionHistory: updatedTransactionHistory,
                        };

                        await updateDoc(docRef, updatedData);

                    } else {
                        const transactionHistory = [
                            {
                                paidAmount: initialPayment,
                                timestamp: new Date().toLocaleString(),
                                transactionMode,
                                invoiceNo: newInvoiceNo,
                            },
                        ];

                        const data = {
                            customerName,
                            phoneNumber,
                            invoiceNumbers: [
                                {
                                    invoiceNo: newInvoiceNo,
                                    transactionType,
                                    date,
                                    items: newItems,
                                    paidAmount: initialPayment,
                                    transactionMode,
                                    totalAmount,
                                    balanceAmount,
                                },
                            ],
                            totalAmount,
                            balanceAmount,
                            transactionHistory,
                        };

                        await addDoc(billsRef, data);



                    }


                    return true; // Success
                } catch (error) {
                    console.error("Error saving/updating transaction:", error);
                    showAlert("Error saving the transaction. Please try again.", 3000);
                    return false; // Failure
                }
            }

            function showAlert(message, duration = 3000) {
                const alertBox = document.getElementById("customAlert");
                alertBox.textContent = message;
                alertBox.style.display = "block";
                setTimeout(() => {
                    alertBox.style.display = "none";
                }, duration);
            }

            // Button event listeners
            document.getElementById("savefb").addEventListener("click", () => {
                handleButtonClick("savefb", () => validateAndSaveTransaction("save"));
            });

            document.getElementById("print").addEventListener("click", () => { window.pdfload(); });

            document.getElementById("creditsave").addEventListener("click", () => {
                handleButtonClick("creditsave", () => validateAndSaveTransaction("savePrint"));
            });

            // Common function to handle button disabling and execution
            function handleButtonClick(buttonId, callback) {
                const button = document.getElementById(buttonId);
                if (button.disabled) return; // Prevent double clicks
                button.disabled = true;     // Disable the button
                button.style.cursor = "not-allowed"; // Optional: Change cursor to indicate disabled state
                callback();                 // Execute the intended function
            }

            // Add keyboard shortcuts
            document.addEventListener("keydown", (event) => {
                if (event.ctrlKey && event.key === "p") {
                    // Ctrl + P for Print
                    event.preventDefault(); // Prevent the browser's default print dialog
                    document.getElementById("print").click();
                } else if (event.ctrlKey && event.key === "s") {
                    // Ctrl + S for Save
                    event.preventDefault(); // Prevent the browser's default save dialog
                    document.getElementById("savefb").click();
                } else if (event.key === "F4") {
                    // F4 for Save & Print
                    document.getElementById("creditsave").click();
                }
            });



        </script>


        <script>



            // date
            const dateField = document.getElementById('dateField');

            // Function to format a date object to 'dd-mm-yyyy'
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            };

            // Function to parse 'dd-mm-yyyy' to a Date object
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day); // Months are 0-indexed
            };

            // Set the default value to today's date
            const today = new Date();
            dateField.value = formatDate(today);

            // Enable editing on click
            dateField.addEventListener('click', () => {
                dateField.removeAttribute('readonly'); // Allow editing

                // Open a date picker by temporarily adding an input of type 'date'
                const datePicker = document.createElement('input');
                datePicker.type = 'date';
                datePicker.style.position = 'absolute';
                datePicker.style.visibility = 'hidden'; // Hide the native date picker
                document.body.appendChild(datePicker);

                // Set the date picker value to the currently displayed date
                const currentDate = parseDate(dateField.value);
                datePicker.value = currentDate.toISOString().split('T')[0]; // Format as 'yyyy-mm-dd'

                datePicker.addEventListener('change', () => {
                    const selectedDate = new Date(datePicker.value);
                    dateField.value = formatDate(selectedDate); // Update field in 'dd-mm-yyyy' format
                    document.body.removeChild(datePicker); // Remove the temporary date picker
                    // dateField.setAttribute('readonly', flase); // Make it readonly again
                });

                // Remove the date picker if the user clicks elsewhere
                datePicker.addEventListener('blur', () => {
                    document.body.removeChild(datePicker);
                    // dateField.setAttribute('readonly', true); // Reapply readonly
                });

                datePicker.click(); // Trigger the date picker
            });

            // Restore readonly attribute on blur
            dateField.addEventListener('blur', () => {
                if (!dateField.value) {
                    dateField.value = formatDate(today); // Reset to today's date if empty
                }
                dateField.setAttribute('readonly', true);
            });










            additem = () => {
                addRow();
            }



            // const addItemButton = document.getElementById('addItemButton');
            const itemTable = document.getElementById('itemTable').querySelector('tbody');
            maxrow = 15
            let rowCount = 0;

            // Enable Add Item button only if the current row is complete
            // const enableAddButton = () => {
            //     const rows = itemTable.querySelectorAll('tr');
            //     const lastRow = rows[rows.length - 1];
            //     const inputs = lastRow.querySelectorAll('input:not([readonly])');
            //     const allFilled = Array.from(inputs).every(input => input.value.trim() !== "");
            //     addItemButton.disabled = !allFilled;
            // };

            // Add a new row to the table
            const addRow = () => {
                rowCount++;
                const row = document.createElement("tr");
                row.innerHTML = `
        <td>${rowCount}</td>
        <td>
            <input type="number" class="item-code-input" list="item-code-suggestions" placeholder="Item Code">
            <datalist id="item-code-suggestions"></datalist>
        </td>
        <td>
            <input type="text" class="item-name-input" list="item-name-suggestions" placeholder="Item Name">
            <datalist id="item-name-suggestions"></datalist>
        </td>
        <td><input type="number" class="qty-input" oninput="validateQty(this)" placeholder="Qty"></td>
        <td><input type="text" class="unit-input" placeholder="Unit" readonly></td>
        <td><input type="number" class="rate-input" oninput="calculateAmount(this)" placeholder="Rate"></td>
        <td><span class="amount-text">0</span></td>
        <td><span class="mrp">0</span></td>
        <td><span class="delete-btn" onclick="deleteRow(this)"><img src="./icons/cross.png" width="15px" alt=""></span></td>
    `;
                itemTable.appendChild(row);

                // Attach event listeners for item code and item name
                const itemCodeInput = row.querySelector(".item-code-input");
                const itemNameInput = row.querySelector(".item-name-input");

                attachEventListenerToInput(itemCodeInput, "itemCode", row);
                attachEventListenerToInput(itemNameInput, "itemName", row);
            };

            // Attach event listeners to inputs
            const attachEventListenerToInput = (inputElement, field, row) => {
                const dataListId = field === "itemCode" ? "item-code-suggestions" : "item-name-suggestions";
                const dataList = document.getElementById(dataListId);

                inputElement.addEventListener("input", async () => {
                    const input = inputElement.value.trim();
                    dataList.innerHTML = ""; // Clear previous suggestions

                    if (input) {
                        const suggestions = await window.fetchSuggestions(input, field);

                        suggestions.forEach((item) => {
                            const option = document.createElement("option");
                            option.value = field === "itemCode" ? item.id : item.itemName;
                            dataList.appendChild(option);
                        });
                    }
                });

                inputElement.addEventListener("change", async () => {
                    const input = inputElement.value.trim();
                    const suggestions = await window.fetchSuggestions(input, field);

                    if (suggestions.length > 0) {
                        const item = suggestions[0]; // Use the first matching item
                        row.querySelector(".item-code-input").value = item.itemCode || "";
                        row.querySelector(".item-name-input").value = item.itemName || "";
                        row.querySelector(".unit-input").value = item.unit || "";
                        row.querySelector(".mrp").textContent = item.mrp || 0;
                        row.dataset.stock = item.stock || 0; // Store stock in the row dataset
                    } else {
                        alert("Item not found.");
                    }
                });
            };

            // Validate quantity input
            const validateQty = (qtyInput) => {
                const row = qtyInput.closest("tr");
                const stock = parseInt(row.dataset.stock, 10) || 0;
                const qty = parseInt(qtyInput.value, 10) || 0;

                if (qty > stock) {
                    alert(`Quantity cannot exceed available stock (${stock}).`);
                    qtyInput.value = stock; // Reset to maximum available stock
                }
            };






            // Add a save button handler








            const toggleDeleteButtonsVisibility = () => {
                const deleteButtons = document.querySelectorAll('.delete-btn');
                const shouldShow = rowCount > 1; // Show only if more than one row
                deleteButtons.forEach(button => {
                    button.style.display = shouldShow ? 'inline-block' : 'none';
                });
            };



            // Check if all inputs in the last row are filled and add a new row
            const checkAndAddRow = () => {
                const rows = itemTable.querySelectorAll("tr");
                const lastRow = rows[rows.length - 1];
                const inputs = lastRow.querySelectorAll("input:not([readonly])");
                const allFilled = Array.from(inputs).every((input) => input.value.trim() !== "");

                if (allFilled) {
                    addRow();
                }
            };
            // const deleteRow = (btn) => {
            //     const row = btn.closest('tr');
            //     row.remove();
            //     updateSerialNumbers();
            //     calculateTotalAmount(); // Recalculate the total after deletion
            //     // enableAddButton();
            // };


            const deleteRow = (button) => {
                const row = button.closest('tr');
                itemTable.removeChild(row);
                rowCount--;
                toggleDeleteButtonsVisibility();
                updateSerialNumbers();
                calculateTotalAmount();
            };





            // Calculate amount (unit price * quantity)
            const calculateAmount = (input) => {
                const row = input.closest('tr');
                const unitPrice = row.querySelector('td:nth-child(6) input').value;
                const quantity = row.querySelector('td:nth-child(4) input').value;
                const amountCell = row.querySelector('td:nth-child(7) .amount-text');
                if (unitPrice && quantity) {
                    const amount = parseFloat(unitPrice) * parseFloat(quantity);
                    amountCell.textContent = amount.toFixed(0);
                } else {
                    amountCell.textContent = '0';
                }

                calculateTotalAmount(); // Recalculate the total amount whenever values are updated
                // enableAddButton();
                checkAndAddRow();
            };



            const initialPayment = document.getElementById("initialPayment").value;
            const totalAmount = parseFloat(document.getElementById("total").textContent || "0");
            const balanceAmount = parseFloat(document.getElementById("balanceAmount").textContent || "0");

            // Calculate total amount
            // Prevent initialPayment from changing on row add/delete
            const calculateTotalAmount = () => {
                const amounts = document.querySelectorAll('.amount-text');
                let sum = 0;
                amounts.forEach(cell => {
                    sum += parseFloat(cell.textContent) || 0;
                });

                document.getElementById('total').textContent = sum.toFixed(0);
                document.getElementById('credtotal').textContent = sum.toFixed(0);

                // Call other dependent functions, but do not modify initialPayment
                FullPaymentCheck();
                updateBalance(); // Update balance based on existing initialPayment
            };
            //FullPayment check logic updated to ensure initialPayment is user-controlled
            function FullPaymentCheck() {
                const transactionType = document.getElementById("transactionType").value;
                const credtotal = parseFloat(document.getElementById("credtotal").textContent || "0");
                const initialPaymentInput = document.getElementById('initialPayment');
                const totalAmount = parseFloat(document.getElementById("total").textContent || "0");
                // console.log(credtotal);


                if (transactionType === "Full Payment") {

                    document.getElementById("balanceAmount").textContent = "0";
                    initialPaymentInput.value = totalAmount
                } else {
                    initialPaymentInput.value = "0"
                    updateBalance(); // Only update balance; do not modify initialPayment
                }
            }


            document.getElementById("transactionType").addEventListener("change", () => {
                FullPaymentCheck();
            });


            // Delete a row

            // Update serial numbers after deleting a row
            const updateSerialNumbers = () => {
                rowCount = 0;
                const rows = itemTable.querySelectorAll('tr');
                rows.forEach(row => {
                    rowCount++;
                    row.querySelector('td:first-child').textContent = rowCount;
                });
            };

            // Add event listener to the Add Item button
            // addItemButton.addEventListener('click', addRow);


            // Add the initial row on page load
            window.onload = () => {
                addRow();
            };




            // credit selected
            const transactionType = document.getElementById('transactionType');
            const creditFields = document.getElementById('creditFields');
            const initialPaymentInput = document.getElementById('initialPayment');
            const balanceAmountSpan = document.getElementById('balanceAmount');
            document.getElementById('initialPayment').value = 0;


            // Total payable amount (Example value, you can replace it dynamically)




            // Show or hide fields based on transaction type



            // Function to update the balance based on total amount and initial payment
            // Function to update the balance based on total amount and initial payment
            const updateBalance = () => {
                const totalAmount = parseFloat(document.getElementById('total').textContent) || 0;
                console.log(totalAmount);

                const initialPayment = parseFloat(initialPaymentInput.value) || 0;
                const balance = totalAmount - initialPayment;
                balanceAmountSpan.textContent = balance.toFixed(0);

            };

            // Attach the `updateBalance` function to relevant events
            initialPaymentInput.addEventListener('input', () => {
                const totalAmount = parseFloat(document.getElementById('total').textContent) || 0;
                const initialPayment = parseFloat(initialPaymentInput.value) || 0;

                // Prevent the user from entering a value greater than the total amount
                if (initialPayment > totalAmount) {
                    initialPaymentInput.value = totalAmount;
                }
                updateBalance(); // Update the balance after validation
            });

            // Update balance whenever the total amount is recalculated
            const originalCalculateTotalAmount = calculateTotalAmount;
            window.calculateTotalAmount = () => {
                originalCalculateTotalAmount(); // Call the original function to calculate total
                updateBalance(); // Update the balance after recalculating the total
            };
            initialPaymentInput.addEventListener('input', () => {
                const totalAmount = parseFloat(document.getElementById('total').textContent) || 0;
                const initialPayment = parseFloat(initialPaymentInput.value) || 0;

                // Prevent the user from entering a value greater than the total amount
                if (initialPayment > totalAmount) {
                    initialPaymentInput.value = totalAmount;
                }
                updateBalance(); // Update the balance after validation
            });


            navigate.addEventListener("click", () => {
                window.history.back();
            });

            function home() {

                window.open('./homePage.html', '_blank');
            }
            function newBill() {
                window.open('./bill.html', '_blank');

            }
            function ledger() {

                window.open('./ledger.html', '_blank');
            }
            function customers() {

                window.open('./customers.html', '_blank');
            }
            function inventory() {

                window.open('./inventory.html', '_blank');
            }









        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
        <script>
            // validate

            // Retrieve input values
            async function pdfload() {
                const { jsPDF } = window.jspdf;

                const customerName = document.getElementById("customerNameName").value.trim();
                const phoneNumber = document.getElementById("phoneNumber").value.trim();
                const date = document.getElementById("dateField").value.trim();
                const invoiceNumber = window.InvoiceNo || "N/A";
                const crrbalance = window.crrbalanceAmount || "N/A";

                const totalAmount = parseFloat(document.getElementById("credtotal").textContent || "0");
                const paidAmount = parseFloat(document.getElementById("initialPayment").value || "0");
                const balanceAmount = totalAmount - paidAmount;
                const updbalance = crrbalance + balanceAmount;

                const table = document.getElementById("itemTable").querySelector("tbody");
                const items = Array.from(table.rows).map((row) => {
                    const cells = row.querySelectorAll("td");
                    return {
                        no: cells[0].textContent,
                        code: cells[1].querySelector("input").value,
                        description: cells[2].querySelector("input").value,
                        quantity: cells[3].querySelector("input").value + " " + cells[4].querySelector("input").value || "",
                        price: cells[5].querySelector("input").value,
                        subtotal: cells[6].textContent,
                    };
                });

                const pdf = new jsPDF();

                // Draw border for the whole PDF
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
                pdf.setLineWidth(0.1); // Set border thickness
                pdf.setDrawColor(0, 0, 0); // Set border color (black)
                pdf.rect(5, 5, pageWidth - 10, pageHeight - 10); // Draw rectangle for border

                // Header section
                pdf.setFontSize(10);
                pdf.text("Issued From:", 15, 30);
                pdf.text("Your Company Name", 15, 35);
                pdf.text("Your Address Line 1", 15, 40);
                pdf.text("City, State, ZIP", 15, 45);

                // "Issued To" Section
                pdf.text("Issued To:", pageWidth - 55, 30);
                pdf.text(customerName, pageWidth - 55, 35);
                pdf.text(phoneNumber, pageWidth - 55, 40);

                // "INVOICE" Title
                pdf.setFontSize(12);
                pdf.text("INVOICE", 105, 15, { align: "center" });

                // Date and Invoice Number
                pdf.setFontSize(10);
                pdf.text(`Date Issued: ${date}`, pageWidth - 55, 55);
                pdf.text(`Invoice No: ${invoiceNumber}`, 15, 55);

                // Table Header
                const headers = ["No", "Item Code", "Item", "Qty", "Price", "Subtotal"];
                const startY = 60;

                pdf.autoTable({
                    head: [headers],
                    body: items.map((item) => [
                        item.no,
                        item.code,
                        item.description,
                        item.quantity,
                        ` ${item.price}`,
                        ` ${item.subtotal}`,
                    ]),
                    startY,
                    theme: "grid",
                    styles: { fontSize: 10, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 15 },  // Column 0 (No) - narrower width
                        1: { cellWidth: 30 },  // Column 1 (Item Code) - wider width
                        2: { cellWidth: 55 },  // Column 2 (Item Description)
                        3: { cellWidth: 20 },  // Column 3 (Qty)
                        4: { cellWidth: 30 },  // Column 4 (Price)
                        5: { cellWidth: 30 },  // Column 5 (Subtotal)
                    },
                });


                // Summary Section
                const summaryStartY = pdf.lastAutoTable.finalY + 10;
                pdf.text(`Grand Total:  ${totalAmount.toFixed(2)}`, pageWidth - 15, summaryStartY, { align: 'right' });
                pdf.text(`Paid Amount:  ${paidAmount.toFixed(2)}`, pageWidth - 15, summaryStartY + 5, { align: 'right' });
                pdf.text(`Balance Amount:  ${balanceAmount.toFixed(2)}`, pageWidth - 15, summaryStartY + 10, { align: 'right' });

                pdf.text(`Old Balance: ${crrbalance}`, 15, summaryStartY);
                pdf.text(`Remaining Balance: ${updbalance}`, 15, summaryStartY + 5);

                // Footer Section
                const footerY = summaryStartY + 30;
                pdf.text("(Signature)", 170, footerY + 10);
                pdf.setFontSize(12);
                pdf.text("THANK YOU", 105, footerY + 30, { align: "center" });

                // Save PDF
                pdf.output('dataurlprint');
                const pdfDataUrl = pdf.output('dataurlstring');
                const filename = `${customerName}_${invoiceNumber}.pdf`.replace(/\s+/g, '_');
                const link = document.createElement('a');
                link.href = pdfDataUrl;
                link.download = filename;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }



        </script>


</body>

</html>